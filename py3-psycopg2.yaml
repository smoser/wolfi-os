environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - postgresql-dev
      - py3-build
      - py3-installer
      - py3-setuptools
      - python3
      - python3-dev
      - wolfi-base

package:
  copyright:
    - license: LGPL-3.0-or-later
  dependencies:
    runtime:
      - python3
  description: psycopg2 - Python-PostgreSQL Database Adapter
  epoch: 1
  name: py3-psycopg2
  version: 2.9.9

pipeline:
  - uses: git-checkout
    with:
      expected-commit: ad5bee7054519d87f25bc5828c502b2ebe197049
      repository: https://github.com/psycopg/psycopg2
      tag: ${{package.version}}

  - name: Python Build
    uses: python/build-wheel

  - uses: strip

test:
  environment:
    contents:
      packages:
        - postgresql
        - postgresql-client
        - wolfi-base
        - shadow
        - sudo-rs
        - glibc-locales
    environment:
      PGDATA: /tmp/test_db
      PGUSER: wolfi
  pipeline:
    - name: Test database creation
      runs: 'useradd $PGUSER

        sudo -u $PGUSER initdb -D /tmp/test_db

        sudo -u $PGUSER pg_ctl -D /tmp/test_db -l /tmp/logfile start

        sudo -u $PGUSER createdb testdb

        psql -lqt | cut -d \| -f 1 | grep -qw testdb

      '
    - name: Test psycopg2
    - runs: "cat <<'EOF' >> /tmp/test.py\nimport psycopg2\n\ndef main():\n    conn = psycopg2.connect(dbname=\"testdb\", user=\"wolfi\")\n    cursor = conn.cursor()\n\n    try:\n        # Create Table\n        cursor.execute(\"\"\"\n            CREATE TABLE IF NOT EXISTS example_table (\n                id SERIAL PRIMARY KEY,\n                message TEXT\n            )\n        \"\"\")\n\n        # Insert value\n        cursor.execute(\"INSERT INTO example_table (message) VALUES (%s)\", (\"Hello Wolfy!\",))\n        conn.commit()\n\n        # Select and print\n        cursor.execute(\"SELECT message FROM example_table\")\n        result = cursor.fetchone()\n        message = result[0]\n        print(\"Message retrieved from database:\", message)\n\n    except Exception as e:\n        print(\"Error:\", e)\n\n    finally:\n        cursor.close()\n        conn.close()\n\nif __name__ == \"__main__\":\n    main()\nEOF\npython3 /tmp/test.py\n"
    - uses: py/pip-check

update:
  enabled: true
  github:
    identifier: psycopg/psycopg2
    use-tag: true
  version-separator: _
